@model Heysundue.Models.SessionuserViewModel
@using Heysundue.Models;

@{
    ViewData["Title"] = "報名人員管理系統";
}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報名人員管理系統</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css">
</head>
<body>
<!-- 编辑会议 Modal -->
<div class="modal fade" id="editMeetingModal" tabindex="-1" aria-labelledby="editMeetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMeetingModalLabel">编辑会议</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMeetingForm">
                    <input type="hidden" id="editMeetingId" />
                    <div class="mb-3">
                        <label for="editMeetingTitle" class="form-label">会议名称：</label>
                        <input type="text" id="editMeetingTitle" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="editMeetingPlace" class="form-label">会议地點：</label>
                        <input type="text" id="editMeetingPlace" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="editMeetingDateTime" class="form-label">会议时间：</label>
                        <input type="datetime-local" id="editMeetingDateTime" class="form-control" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="editMeeting()">保存更改</button>
            </div>
        </div>
    </div>
</div>
<div class="row mb-3">
    <div class="col-md-6">
        <h5>總人數: <span id="totalUsers">0</span></h5>
        <h5>已報到: <span id="checkedInUsers">0</span></h5>
    </div>
</div>

<div class="container mt-5">
    <h2 class="mb-4">報名人員名單</h2>
    
    <div class="row mb-3">
        <!-- 下拉菜单选择会议 -->
        <div class="col-md-4">
            <label for="meetingSelect">选择会议:</label>
            <select id="meetingSelect" class="form-select" onchange="loadSessionUsers(this.value)">
                <!-- 動態生成選項 -->
            </select>
        </div>

        <!-- 新增和删除会议按钮 -->
        <div class="col-md-8 text-end">
            <button class="btn btn-primary" onclick="showAddMeetingModal()">新增会议</button>
            <button class="btn btn-danger" onclick="deleteSelectedMeeting()">删除会议</button>
        </div>
    </div>
<div id="meetingTable" class="mb-3">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>会议名称</th>
                <th>会议地點</th>
                <th>会议时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="meetingTableBody"></tbody>
    </table>
</div>
<div class="modal fade" id="addMeetingModal" tabindex="-1" aria-labelledby="addMeetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMeetingModalLabel">新增会议</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMeetingForm">
                    <div class="mb-3">
                        <label for="meetingTitle" class="form-label">会议名称：</label>
                        <input type="text" id="meetingTitle" name="title" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="meetingPlace" class="form-label">会议地點：</label>
                        <input type="text" id="meetingPlace" name="place" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="meetingDateTime" class="form-label">会议时间：</label>
                        <input type="datetime-local" id="meetingDateTime" name="meetingDateTime" class="form-control" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addMeeting()">新增</button>
            </div>
        </div>
    </div>
</div>


    <div class="row mb-3">
        <div class="col-auto">
            <button class="btn btn-primary mb-2" onclick="showAddParticipantModal()">新增人員</button>
        </div>
    </div>

    <form id="searchForm" method="post" action="@Url.Action("SearchSessionuser", "Sessionuser")">
        <div class="row mb-3">
            <!-- 搜尋欄位選擇 -->
            <div class="col-md-4">
                <select id="searchColumn" class="form-select" name="SearchColumn">
                    <option value="all">選擇搜尋欄位:</option>
                    <option value="regno">Reg. No.</option>
                    <option value="firstname">First Name</option>
                    <option value="lastname">Last Name</option>
                    <option value="chinesename">中文姓名</option>
                    <option value="country">Country</option>
                    <option value="registrationstatus">報到狀態</option>
                    <option value="email">Email</option>
                    <option value="city">City</option>
                    <option value="identitytype1">身份別一</option>
                    <option value="identitytype2">身份別二</option>
                    <option value="idnumber">身份證號碼</option>
                </select>
            </div>

            <!-- 搜尋輸入框 -->
            <div class="col-md-4">
                <input type="text" id="searchKeyword" name="SearchKeyword" class="form-control" placeholder="請輸入關鍵字" disabled />
            </div>

            <!-- 搜尋按鈕 -->
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary">搜尋</button>
                <button type="button" class="btn btn-secondary" onclick="clearSearch()">清除</button>
            </div>
        </div>
    </form>

    <!-- 表格 -->
    <div class="row mb-3">
        <div class="col">
            <table class="table">
                <thead class="custom-table-header">
                    <tr>
                        <th>Reg. No.</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>中文姓名</th>
                        <th>Country</th>
                        <th>報到狀態</th>
                        <th>Barcode</th>
                        <th>Email</th>
                        <th>City</th>
                        <th>身份別一</th>
                        <th>身份別二</th>
                        <th>身份證號碼</th>
                    </tr>
                </thead>
                <tbody id="sessionuserTableBody">
    @if (Model.Sessionusers != null)
    {
        foreach (var sessionuser in Model.Sessionusers)
        {
            <tr>
                <td>
                    <a href="@Url.Action("Edit", "Sessionuser", new { id = sessionuser.ID })">
                        @sessionuser.RegNo
                    </a>
                </td>
                <td>@sessionuser.FirstName</td>
                <td>@sessionuser.LastName</td>
                <td>@sessionuser.ChineseName</td>
                <td>@sessionuser.Country</td>
                <td>@sessionuser.RegistrationStatus</td>
                <td>@sessionuser.Barcode</td>
                <td>@sessionuser.Email</td>
                <td>@sessionuser.City</td>
                <td>@sessionuser.IdentityType1</td>
                <td>@sessionuser.IdentityType2</td>
                <td>@sessionuser.IDNumber</td>
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="12">No sessionusers available.</td>
        </tr>
    }
</tbody>

            </table>
        </div>
    </div>

    <div id="pagination" class="row">
        <div class="col text-center">
            <button class="btn btn-primary" onclick="previousPage()" @(Model.CurrentPage <= 1 ? "disabled" : "")>上一頁</button>
            <span>頁數: @Model.CurrentPage / @Model.TotalPages</span> <!-- 頁數由後端動態生成 -->
            <button class="btn btn-primary" onclick="nextPage()" @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")>下一頁</button>
        </div>
    </div>
</div>

<!-- 新增人員 Modal -->
<div class="modal fade" id="addParticipantModal" tabindex="-1" aria-labelledby="addParticipantModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addParticipantModalLabel">現場報名</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addParticipantForm" method="post" action="/Sessionuser/AddSessionuser">
                    <input type="hidden" name="Sessionuser.MeetingID" id="SessionuserMeetingID" value="">
                    <div asp-validation-summary="All" class="text-danger"></div>
                    
                    <!-- First Name -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.FirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                        <input asp-for="Sessionuser.FirstName" name="Sessionuser.FirstName" class="form-control" required />
                        <span asp-validation-for="Sessionuser.FirstName" class="text-danger"></span>
                    </div>

                    <!-- Last Name -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.LastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                        <input asp-for="Sessionuser.LastName" name="Sessionuser.LastName" class="form-control" required />
                        <span asp-validation-for="Sessionuser.LastName" class="text-danger"></span>
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.Email" class="form-label">Email <span class="text-danger">*</span></label>
                        <input asp-for="Sessionuser.Email" name="Sessionuser.Email" class="form-control" required />
                        <span asp-validation-for="Sessionuser.Email" class="text-danger"></span>
                    </div>

                    <!-- ID Number -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.IDNumber" class="form-label">身份證號碼 <span class="text-danger">*</span></label>
                        <input asp-for="Sessionuser.IDNumber" name="Sessionuser.IDNumber" class="form-control" required />
                        <span asp-validation-for="Sessionuser.IDNumber" class="text-danger"></span>
                    </div>

                    <!-- 中文姓名 -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.ChineseName" class="form-label">中文姓名</label>
                        <input asp-for="Sessionuser.ChineseName" name="Sessionuser.ChineseName" class="form-control" />
                        <span asp-validation-for="Sessionuser.ChineseName" class="text-danger"></span>
                    </div>

                    <!-- Country -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.Country" class="form-label">Country</label>
                        <input asp-for="Sessionuser.Country" name="Sessionuser.Country" class="form-control" />
                        <span asp-validation-for="Sessionuser.Country" class="text-danger"></span>
                    </div>

                    <!-- City -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.City" class="form-label">City</label>
                        <input asp-for="Sessionuser.City" name="Sessionuser.City" class="form-control" />
                        <span asp-validation-for="Sessionuser.City" class="text-danger"></span>
                    </div>

                    <!-- Identity Type 1 -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.IdentityType1" class="form-label">身份別一</label>
                        <input asp-for="Sessionuser.IdentityType1" name="Sessionuser.IdentityType1" class="form-control" />
                        <span asp-validation-for="Sessionuser.IdentityType1" class="text-danger"></span>
                    </div>

                    <!-- Identity Type 2 -->
                    <div class="mb-3">
                        <label asp-for="Sessionuser.IdentityType2" class="form-label">身份別二</label>
                        <input asp-for="Sessionuser.IdentityType2" name="Sessionuser.IdentityType2" class="form-control" />
                        <span asp-validation-for="Sessionuser.IdentityType2" class="text-danger"></span>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="addParticipant()">新增</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 加載 jQuery 和 Bootstrap -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Initialization and AJAX functions
$(document).ready(function () {
    loadMeetingData();
    $('#meetingSelect').on('change', function () {
        const selectedMeetingId = $(this).val();
        if (selectedMeetingId) {
            loadSessionUsers(selectedMeetingId);
        }
    });
    $('#searchColumn').on('change', function() {
        if ($(this).val() === 'all') {
            $('#searchKeyword').val('').attr('disabled', true);
        } else {
            $('#searchKeyword').removeAttr('disabled');
        }
    });
    $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        searchKeyword();
    });
});

function showAddMeetingModal() {
    $('#addMeetingModal').modal('show'); // 顯示新增會議的 Modal
}

function clearSearch() {
    $('#searchColumn').val('all');
    $('#searchKeyword').val('').attr('disabled', true);
    var token = $('input[name="__RequestVerificationToken"]').val();

    $.ajax({
        url: '@Url.Action("SearchSessionuser", "Sessionuser")',
        type: 'POST',
        data: { __RequestVerificationToken: token, searchColumn: 'all', searchKeyword: '', page: 1 },
        success: function (data) {
            if (data.tableHtml) {
                $('#sessionuserTableBody').html(data.tableHtml);
                updatePagination(data.currentPage, data.totalPages);
            }
        },
        error: function (xhr, status, error) {
            console.error("Error in AJAX request: " + error, xhr.responseText);
        }
    });
}

function searchKeyword() {
    var column = $('#searchColumn').val();
    var keyword = $('#searchKeyword').val();
    var token = $('input[name="__RequestVerificationToken"]').val();

    $.ajax({
        url: '@Url.Action("SearchSessionuser", "Sessionuser")',
        type: 'POST',
        data: { __RequestVerificationToken: token, searchColumn: column, searchKeyword: keyword, page: 1 },
        success: function (data) {
            if (data.tableHtml) {
                $('#sessionuserTableBody').html(data.tableHtml);
                updatePagination(data.currentPage, data.totalPages);
            }
        },
        error: function (xhr, status, error) {
            console.error("Error in AJAX request: " + error, xhr.responseText);
        }
    });
}

function nextPage() {
    var currentPage = parseInt(document.querySelector("#pagination span").textContent.split(":")[1].split("/")[0].trim());
    var totalPages = parseInt(document.querySelector("#pagination span").textContent.split("/")[1].trim());
    if (currentPage < totalPages) loadPage(currentPage + 1);
}

function previousPage() {
    var currentPage = parseInt(document.querySelector("#pagination span").textContent.split(":")[1].split("/")[0].trim());
    if (currentPage > 1) loadPage(currentPage - 1);
}

function showAddParticipantModal() {
    var selectedMeetingId = $('#meetingSelect').val();
    if (!selectedMeetingId) {
        alert('請先選擇會議');
        return;
    }

    $('#SessionuserMeetingID').val(selectedMeetingId); // 將選擇的會議 ID 綁定
    $('#addParticipantModal').modal('show'); // 顯示新增人員的 Modal
}



// Loading data for meetings
function loadMeetingData(selectedMeetingId = null) {
    $.getJSON('/Sessionuser/GetMeetings', function (data) {
        $('#meetingSelect').empty();
        $('#meetingTableBody').empty();

        if (data && data.length > 0) {
            data.forEach(meeting => {
                // 表格中的一行
                const rowHtml = `
                    <tr>
                        <td>${meeting.title}</td>
                        <td>${meeting.place}</td>
                        <td>${new Date(meeting.meetingDateTime).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="showEditMeetingModal(${meeting.id}, '${meeting.title}','${meeting.place}', '${meeting.meetingDateTime}')">编辑</button>
                        </td>
                    </tr>
                `;
                $('#meetingTableBody').append(rowHtml);

                // 下拉選單的選項
                $('#meetingSelect').append(new Option(meeting.title, meeting.id)); // 將第二個參數設置為 meeting.id
            });

            // 預選第一個會議
            const firstMeetingId = selectedMeetingId || data[0].id;
            $('#meetingSelect').val(firstMeetingId);
            loadSessionUsers(firstMeetingId);
        } else {
            $('#meetingSelect').append(new Option('无会议', ''));
            $('#meetingTableBody').html('<tr><td colspan="3">暂无会议数据</td></tr>');
        }
    }).fail(function (jqXHR, textStatus, errorThrown) {
        console.error('加载会议失败:', textStatus, errorThrown);
    });
}

function addMeeting() {
    var title = $('#meetingTitle').val();
    var place = $('#meetingPlace').val();
    var meetingDateTime = $('#meetingDateTime').val();

    if (!title || !place || !meetingDateTime) {
        alert('請完整填寫會議名稱、地點和時間');
        return;
    }

    $.ajax({
        url: '/Sessionuser/AddMeeting',
        type: 'POST',
        data: { title: title, place: place, meetingDateTime: meetingDateTime },
        success: function (data) {
            if (data.success) {
                $('#addMeetingModal').modal('hide');
                loadMeetingData(data.meetingId); // 重新加载会议列表
            } else {
                alert(data.message || '新增會議失敗');
            }
        },
        error: function (xhr, status, error) {
            console.error('新增会议失败:', error, xhr.responseText);
            alert('新增会议失败，请检查网络或后端服务。');
        }
    });
}



function deleteSelectedMeeting() {
    var meetingId = $('#meetingSelect').val();
    if (!meetingId) {
        alert('請選擇一個會議');
        return;
    }

    $.post('/Sessionuser/DeleteMeeting', { meetingId: meetingId }, function (data) {
        if (data.success) {
            alert('會議已刪除');
            loadMeetingData(); // 重新加載會議
        } else {
            alert(data.message || '刪除失敗');
        }
    }).fail(function (xhr, status, error) {
        console.error('刪除失敗:', error, xhr.responseText);
    });
}


function loadSessionUsers(meetingId) {
    if (!meetingId) {
        $('#sessionuserTableBody').html('<tr><td colspan="12">No session users available for this meeting.</td></tr>');
        return;
    }

    // 加載統計數據
    $.getJSON('/Sessionuser/GetMeetingStats', { meetingId: meetingId }, function (stats) {
        $('#totalUsers').text(stats.totalUsers);
        $('#checkedInUsers').text(stats.checkedInUsers);
    });

    // 加載會議人員
    $.getJSON('/Sessionuser/LoadSessionUsers', { meetingId: meetingId }, function (data) {
        $('#sessionuserTableBody').empty();
        if (data && data.length > 0) {
            $.each(data, function (index, user) {
                const statusText = user.registrationStatus ? 
                    '<span class="text-success">已報到</span>' : 
                    '<span class="text-danger">未報到</span>';
                
                const rowHtml = `
                    <tr>
                        <td>
                            <a href="/Sessionuser/Edit/${user.id}">
                                ${user.regNo || ''}
                            </a>
                        </td>
                        <td>${user.firstName || ''}</td>
                        <td>${user.lastName || ''}</td>
                        <td>${user.chineseName || ''}</td>
                        <td>${user.country || ''}</td>
                        <td>${statusText}</td>
                        <td>${user.email || ''}</td>
                        <td>${user.city || ''}</td>
                        <td>${user.identityType1 || ''}</td>
                        <td>${user.identityType2 || ''}</td>
                        <td>${user.idNumber || ''}</td>
                    </tr>
                `;
                $('#sessionuserTableBody').append(rowHtml);
            });
        } else {
            $('#sessionuserTableBody').append('<tr><td colspan="12">No session users available for this meeting.</td></tr>');
        }
    });
}

function addParticipant() {
    var firstName = $("input[name='Sessionuser.FirstName']").val().trim();
    var lastName = $("input[name='Sessionuser.LastName']").val().trim();
    var email = $("input[name='Sessionuser.Email']").val().trim();
    var idNumber = $("input[name='Sessionuser.IDNumber']").val().trim();
    
    if (!firstName || !lastName || !email || !idNumber) {
        alert("請填寫完整的 First Name, Last Name, Email 和 身份證號碼");
        return;
    }

    var formData = $('#addParticipantForm').serialize();

    $.ajax({
        url: '/Sessionuser/AddSessionuser',
        type: 'POST',
        data: formData,
        success: function (response) {
            if (response.success) {
                $('#addParticipantModal').modal('hide');
                loadSessionUsers($('#meetingSelect').val()); // 重新加載會議人員
            } else {
                alert(response.message || '新增人員失敗');
            }
        },
        error: function (xhr, status, error) {
            if (xhr.responseText.includes("該身份證號碼已申請過")) {
                alert("該身份證號碼已申請過，無法重複新增");
                return;
            }
            console.error('新增人員失敗:', error, xhr.responseText);
        }
    });
}




function updatePagination(currentPage, totalPages) {
    document.querySelector("#pagination span").textContent = `頁數: ${currentPage} / ${totalPages}`;
    document.querySelector("#pagination .btn-primary:first-child").disabled = currentPage <= 1;
    document.querySelector("#pagination .btn-primary:last-child").disabled = currentPage >= totalPages;
}

function showEditMeetingModal(id, title,place, meetingDateTime) {
    $('#editMeetingId').val(id);
    $('#editMeetingTitle').val(title);
    $('#editMeetingPlace').val(place);
    $('#editMeetingDateTime').val(new Date(meetingDateTime).toISOString().slice(0, 16)); // 格式化日期
    $('#editMeetingModal').modal('show');
}


function editMeeting() {
    const id = $('#editMeetingId').val();
    const title = $('#editMeetingTitle').val();
    const place = $('#editMeetingPlace').val();
    const meetingDateTime = $('#editMeetingDateTime').val();

    if (!title || !meetingDateTime || !place) {
        alert('请完整填写会议名称和时间');
        return;
    }

    $.post('/Sessionuser/EditMeeting', { id, title, place,meetingDateTime }, function (data) {
        if (data.success) {
            $('#editMeetingModal').modal('hide');
            loadMeetingData(); // 重新加载会议数据
        } else {
            alert(data.message || '更新会议失败');
        }
    }).fail(function () {
        alert('无法更新会议，请检查网络或后端服务。');
    });
}


function loadMeetingData(selectedMeetingId = null) {
    $.getJSON('/Sessionuser/GetMeetings', function (data) {
        $('#meetingSelect').empty();
        $('#meetingTableBody').empty();

        if (data && data.length > 0) {
            data.forEach(meeting => {
                // 更新表格
                const rowHtml = `
                    <tr>
                        <td>${meeting.title}</td>
                        <td>${meeting.place}</td>
                        <td>${new Date(meeting.meetingDateTime).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="showEditMeetingModal(${meeting.id}, '${meeting.title}', '${meeting.place}', '${meeting.meetingDateTime}')">编辑</button>
                        </td>
                    </tr>
                `;
                $('#meetingTableBody').append(rowHtml);

                // 更新下拉選單
                $('#meetingSelect').append(new Option(meeting.title, meeting.id)); // 確保值為 meeting.id
            });

            // 預設選中第一個會議
            const firstMeetingId = selectedMeetingId || data[0].id;
            $('#meetingSelect').val(firstMeetingId);
            loadSessionUsers(firstMeetingId);
        } else {
            $('#meetingSelect').append(new Option('无会议', ''));
            $('#meetingTableBody').html('<tr><td colspan="3">暂无会议数据</td></tr>');
        }
    }).fail(function (jqXHR, textStatus, errorThrown) {
        console.error('加載會議失敗:', textStatus, errorThrown);
    });
}


</script>
</body>
</html>

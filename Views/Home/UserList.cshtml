<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/css/Joinlist.css">
    <title>用戶列表</title>
</head>

<body>

    <div class="container mt-5">
        <h2 class="mb-4">用戶列表</h2>

        <div class="row mb-3">
            <div class="col-auto">
                <button class="btn btn-primary mb-2" onclick="window.location.href='@Url.Action("InputUser", "Home")'">新增用戶</button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-3">
                <input type="text" id="searchKeyword" class="form-control" placeholder="搜尋關鍵字">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-3">
                <select id="searchType" class="form-select">
                    <option value="">選擇搜尋類型</option>
                    <option value="userName">用戶名</option>
                    <option value="email">電子郵件</option>
                    <option value="phone">電話</option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-3">
                <input type="date" id="startDate" class="form-control" placeholder="開始日期">
            </div>
            <div class="col-3">
                <input type="date" id="endDate" class="form-control" placeholder="結束日期">
            </div>
            <div class="col-2">
                <button class="btn btn-primary" onclick="clearFilters()">清除篩選</button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <table class="table">
                    <thead class="custom-table-header">
                        <tr>
                            <th>編號</th>
                            <th>用戶名</th>
                            <th>密碼</th>
                            <th>電子郵件</th>
                            <th>電話</th>
                            <th>創建日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="userTable">
                        <!-- 這裡將動態生成用戶的資料列 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 編輯用戶模態框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">編輯用戶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUserName" class="form-label">用戶名</label>
                            <input type="text" class="form-control" id="editUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">密碼</label>
                            <input type="password" class="form-control" id="editPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">電子郵件</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">電話</label>
                            <input type="tel" class="form-control" id="editPhone" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModal()">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">儲存變更</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const users = JSON.parse(localStorage.getItem('users')) || [];

        function renderUserTable(filteredUsers) {
            const userTable = document.getElementById('userTable');
            userTable.innerHTML = '';

            filteredUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.userName}</td>
                    <td>${user.password}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td>${user.createDate}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editUser(${index})">編輯</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${index})">刪除</button>
                    </td>
                `;
                userTable.appendChild(row);
            });
        }

        function filterUsers() {
            const keyword = document.getElementById('searchKeyword').value.toLowerCase();
            const type = document.getElementById('searchType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const filteredUsers = users.filter(user => {
                const matchesKeyword = !keyword || Object.values(user).some(value => 
                    value.toString().toLowerCase().includes(keyword));
                const matchesType = !type || user[type]?.toLowerCase().includes(keyword);
                const matchesDate = (!startDate || new Date(user.createDate) >= new Date(startDate)) &&
                                    (!endDate || new Date(user.createDate) <= new Date(endDate));
                return matchesKeyword && matchesType && matchesDate;
            });

            renderUserTable(filteredUsers);
        }

        function clearFilters() {
            document.getElementById('searchKeyword').value = '';
            document.getElementById('searchType').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            renderUserTable(users);
        }

        function editUser(index) {
            const user = users[index];
            document.getElementById('editUserId').value = index;
            document.getElementById('editUserName').value = user.userName;
            document.getElementById('editPassword').value = user.password;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPhone').value = user.phone;
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        function saveUser() {
            const index = document.getElementById('editUserId').value;
            users[index] = {
                userName: document.getElementById('editUserName').value,
                password: document.getElementById('editPassword').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                createDate: users[index].createDate
            };
            localStorage.setItem('users', JSON.stringify(users));
            closeModal();
        }

        function deleteUser(index) {
            users.splice(index, 1);
            localStorage.setItem('users', JSON.stringify(users));
            renderUserTable(users);
        }

        function closeModal() {
            const modalElement = document.getElementById('editUserModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
            window.location.href = '@Url.Action("UserList", "Home")';
        }

        document.getElementById('searchKeyword').addEventListener('input', filterUsers);
        document.getElementById('searchType').addEventListener('change', filterUsers);
        document.getElementById('startDate').addEventListener('change', filterUsers);
        document.getElementById('endDate').addEventListener('change', filterUsers);

        // 初始渲染用戶表格
        renderUserTable(users);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
